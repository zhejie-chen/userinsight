<template>
  <main id="main-content" class="pt-11 bg-gray-50 min-h-screen">
    <div class="main-layout" ref="mainLayoutRef">
      <div class="left-panel-spacer"></div>

      <Teleport to="body">
        <div
            v-if="isDesktop"
            class="timeline-card-container"
            :class="{
              'is-blurred': isMainContentBlurred,
              'is-ready': isTimelineReady
            }"
            :style="{ left: timelineLeftPos }"
        >
          <div class="timeline-card">
            <div class="timeline-header">
              <h2 class="timeline-title">发布会日程</h2>
            </div>
            <div class="timeline-scroll-area">
              <div v-if="isLoadingEvents">
                <div v-for="n in 5" :key="`skel-tl-${n}`" class="timeline-skeleton">
                  <div class="avatar skeleton-loader"></div>
                  <div class="text-group">
                    <div class="line-1 skeleton-loader"></div>
                    <div class="line-2 skeleton-loader"></div>
                  </div>
                </div>
              </div>

              <div v-else>
                <div
                    v-for="(group, monthKey) in upcomingEventGroups"
                    :key="monthKey"
                    class="month-group-timeline"
                >
                  <div class="month-header">{{ monthKey }}</div>
                  <div class="timeline">
                    <div
                        v-for="item in group"
                        :key="item.id"
                        class="timeline-item"
                        :class="{
                        'has-report': item.hasReport,
                        'is-active': item.id === activeTimelineEventId
                      }"
                        @click="handleTimelineClick(item)"
                        :tabindex="item.hasReport ? 0 : -1"
                    >
                      <div class="date-marker">
                        <span class="day">{{ item.day }}</span>
                        <span class="weekday">{{ item.weekday }}</span>
                      </div>
                      <div class="event-details">
                        <p class="event-title">{{ item.title }}</p>
                        <div class="badges-container">
                          <span class="report-badge report-badge-upcoming">预计</span>
                          <span v-if="item.hasReport" class="report-badge hover-badge">查看报告</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div v-if="Object.keys(pastEventGroups).length > 0" class="past-events-section">
                  <h3 class="past-events-title">过往发布会</h3>
                  <div
                      v-for="(group, monthKey) in pastEventGroups"
                      :key="monthKey"
                      class="month-group-timeline"
                  >
                    <div class="month-header">{{ monthKey }}</div>
                    <div class="timeline">
                      <div
                          v-for="item in group"
                          :key="item.id"
                          class="timeline-item is-past"
                          :class="{
                          'has-report': item.hasReport,
                          'is-active': item.id === activeTimelineEventId
                        }"
                          @click="handleTimelineClick(item)"
                          :tabindex="item.hasReport ? 0 : -1"
                      >
                        <div class="date-marker">
                          <span class="day">{{ item.day }}</span>
                          <span class="weekday">{{ item.weekday }}</span>
                        </div>
                        <div class="event-details">
                          <p class="event-title">{{ item.title }}</p>
                          <div class="badges-container">
                            <span v-if="item.hasReport" class="report-badge report-badge-archived">报告</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </Teleport>

      <div class="right-panel">
        <div class="right-panel-content-area">
          <div class="page-header mb-12">
            <h1 class="text-4xl font-bold text-gray-800">新车发布会</h1>
          </div>
          <div class="space-y-16">
            <div v-if="isLoadingReports">
              <div
                  v-for="month in skeletonMonths"
                  :key="month"
                  class="month-group-reports"
              >
                <div class="month-divider">
                  <span class="month-text">{{ month }}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-8">
                  <div v-for="n in 4" :key="`skel-card-${month}-${n}`" class="report-card-skeleton">
                    <div class="image-placeholder skeleton-loader"></div>
                    <div class="content">
                      <div class="line-1 skeleton-loader"></div>
                      <div class="line-2 skeleton-loader"></div>
                      <div class="line-3 skeleton-loader"></div>
                      <div class="line-4 skeleton-loader"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div
                v-else
                v-for="(group, month) in groupedConferences"
                :key="month"
                class="month-group-reports"
            >
              <div class="month-divider">
                <span class="month-text">{{ month }}</span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-8">
                <div
                    v-for="conference in group"
                    :key="conference.id"
                    :ref="el => { if (el) conferenceCardRefs[conference.id] = el }"
                    class="conference-card group bg-white rounded-lg"
                    :class="{ 'is-active': conference.id === activeConferenceId }"
                    @click="handleCardClick(conference)"
                >
                  <div class="relative" style="padding-bottom: 42.6%">
                    <img :src="conference.image" :alt="conference.title" class="absolute h-full w-full object-cover"/>
                  </div>
                  <div class="p-5">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">{{ conference.title }}</h3>
                    <p class="text-gray-600 text-sm h-14 overflow-hidden mb-4">{{ conference.description }}</p>
                    <div class="card-meta flex justify-between items-center text-xs text-gray-500">
                      <span>{{ conference.date }}</span>
                      <div class="meta-action">
                        <span class="default-text">用户洞察</span>
                        <a
                            v-if="conference.replayUrl"
                            :href="conference.replayUrl"
                            target="_blank"
                            class="hover-link"
                            @click.stop
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="link-icon">
                            <path d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.665l3-3z" />
                            <path d="M8.603 14.397a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 005.656 5.656l3-3a4 4 0 00-.225-5.865.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.665l-3 3z" />
                          </svg>
                          直播回放
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <DetailModal :isOpen="isModalOpen" :conference="selectedConference" @close="closeConferenceModal" />

  </main>
</template>

<script setup>
import { ref, computed, onBeforeUpdate, reactive, onMounted, onUnmounted, nextTick } from 'vue';
import DetailModal from '@/components/common/DetailModal.vue';
import { getTimelineEvents, getConferenceReports, getReportImages } from '@/services/api/conferences.js';


// --- Data & Loading State ---
const timelineEvents = ref([]);
const conferences = ref([]);
const isLoadingEvents = ref(true);
const isLoadingReports = ref(true);

// --- Image Prefetching Cache ---
const imageCache = new Map();

// --- Modal State Management ---
const isModalOpen = ref(false);
const selectedConference = ref(null);

async function openConferenceModal(conference) {
  selectedConference.value = {
    ...conference,
    details: {
      team: conference.team || '未知团队',
      images: [] // Start with an empty images array
    }
  };
  isModalOpen.value = true;

  // Check cache first
  if (imageCache.has(conference.id)) {
    console.log(`Modal images for ${conference.id} found in cache.`);
    selectedConference.value.details.images = imageCache.get(conference.id);
    return;
  }

  // If not in cache, fetch them
  try {
    console.log(`Modal for ${conference.id} opened. Fetching images...`);
    const images = await getReportImages(conference.id);
    if (selectedConference.value && selectedConference.value.id === conference.id) {
      selectedConference.value.details.images = images;
      imageCache.set(conference.id, images); // Store in cache
    }
  } catch (error) {
    console.error(`Failed to fetch images for conference ${conference.id}:`, error);
  }
}

function closeConferenceModal() {
  isModalOpen.value = false;
  selectedConference.value = null;
}

// --- Unified Card Click Handler ---
function handleCardClick(conference) {
  if (conference.action_type === 'EXTERNAL_LINK' && conference.external_url) {
    window.open(conference.external_url, '_blank');
  } else {
    openConferenceModal(conference);
  }
}

// --- Timeline Click Handler for Scrolling & Prefetching ---
function handleTimelineClick(item) {
  if (!item.hasReport) return;

  // 1. Scroll to the conference card
  scrollToConference(item.reportId, item.id);

  // 2. Prefetch images if it's a modal action and not already cached
  const relatedConference = conferences.value.find(c => c.id === item.reportId);
  if (relatedConference && relatedConference.action_type !== 'EXTERNAL_LINK' && !imageCache.has(item.reportId)) {
    console.log(`Prefetching images for reportId: ${item.reportId}`);
    getReportImages(item.reportId)
        .then(images => {
          imageCache.set(item.reportId, images);
          console.log(`Successfully prefetched and cached ${images.length} images for ${item.reportId}.`);
        })
        .catch(err => {
          console.error(`Prefetching failed for ${item.reportId}:`, err);
        });
  }
}

// --- Highlighting Logic ---
const activeConferenceId = ref(null);
const activeTimelineEventId = ref(null);
let highlightTimer = null;

// --- Layout & Blur Sync Logic ---
const isDesktop = ref(window.innerWidth > 1024);
const mainLayoutRef = ref(null);
const timelineLeftPos = ref('0px'); // Start at 0, will be calculated
const isTimelineReady = ref(false); // Flag to control timeline animation
const isMainContentBlurred = ref(false);
let observer = null;

const updateTimelinePosition = async () => {
  if (mainLayoutRef.value && isDesktop.value) {
    // Wait for the DOM to be fully updated before measuring
    await nextTick();
    const rect = mainLayoutRef.value.getBoundingClientRect();
    // Use a fallback of 32px if left is 0, which can happen during initial render
    const leftPosition = rect.left > 0 ? rect.left : 32;
    timelineLeftPos.value = `${leftPosition}px`;
    isTimelineReady.value = true; // Position is set, trigger the animation
  }
};

onMounted(async () => {
  isLoadingEvents.value = true;
  isLoadingReports.value = true;

  const handleResize = () => {
    const oldIsDesktop = isDesktop.value;
    isDesktop.value = window.innerWidth > 1024;
    if (oldIsDesktop !== isDesktop.value || !isTimelineReady.value) {
      updateTimelinePosition();
    }
  };

  handleResize();
  window.addEventListener('resize', handleResize);

  try {
    const eventsPromise = getTimelineEvents();
    const reportsPromise = getConferenceReports();

    const eventsData = await eventsPromise;
    isLoadingEvents.value = false;

    const reportsData = await reportsPromise;

    const reportMap = new Map(reportsData.map(r => [r.event_id, r.id]));
    timelineEvents.value = eventsData.map(event => {
      const originalEventId = event.id.replace('evt-', '');
      const reportId = reportMap.get(originalEventId);
      return { ...event, reportId: reportId || null };
    });

    conferences.value = reportsData;
    isLoadingReports.value = false;

  } catch (error) {
    console.error("Failed to load data:", error);
    isLoadingEvents.value = false;
    isLoadingReports.value = false;
  }

  const mainContent = document.getElementById('main-content');
  if (mainContent) {
    isMainContentBlurred.value = mainContent.classList.contains('blurred');
    observer = new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        if (mutation.attributeName === 'class') {
          isMainContentBlurred.value = mainContent.classList.contains('blurred');
        }
      });
    });
    observer.observe(mainContent, { attributes: true });
  }
});

onUnmounted(() => {
  window.removeEventListener('resize', () => { isDesktop.value = window.innerWidth > 1024; updateTimelinePosition(); });
  if (observer) observer.disconnect();
  if (highlightTimer) clearTimeout(highlightTimer);
});

// --- Scrolling & Highlighting Logic ---
const conferenceCardRefs = reactive({});
onBeforeUpdate(() => { Object.keys(conferenceCardRefs).forEach(key => delete conferenceCardRefs[key]); });

const scrollToConference = (reportId, eventId) => {
  const cardElement = conferenceCardRefs[reportId];
  if (cardElement) {
    cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    activeConferenceId.value = reportId;
    activeTimelineEventId.value = eventId;
    if (highlightTimer) clearTimeout(highlightTimer);
    highlightTimer = setTimeout(() => {
      activeConferenceId.value = null;
      activeTimelineEventId.value = null;
    }, 2500);
  }
};

// --- COMPUTED PROPERTIES ---

// --- CHANGE HERE: Only show one month skeleton ---
const skeletonMonths = computed(() => {
  const today = new Date('2025-10-27T00:00:00');
  return [`${today.getFullYear()}年 ${today.toLocaleString('zh-CN', { month: 'long' })}`];
});

const processAndGroupEvents = (events, isPastFilter) => {
  const today = new Date('2025-10-27T00:00:00');
  const conferenceIdsWithReports = new Set(conferences.value.map(c => c.id));

  const filtered = events.filter(event => {
    const eventDate = new Date(event.date);
    return isPastFilter ? eventDate < today : eventDate >= today;
  });

  const processed = [...filtered]
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .map(event => {
        const eventDate = new Date(event.date);
        return {
          ...event,
          day: eventDate.getDate(),
          weekday: eventDate.toLocaleString('zh-CN', { weekday: 'short' }),
          hasReport: event.reportId !== null && conferenceIdsWithReports.has(event.reportId),
        };
      });

  return processed.reduce((acc, event) => {
    const date = new Date(event.date);
    const key = `${date.getFullYear()}年 ${date.toLocaleString('zh-CN', { month: 'long' })}`;
    if (!acc[key]) acc[key] = [];
    acc[key].push(event);
    return acc;
  }, {});
};
const upcomingEventGroups = computed(() => processAndGroupEvents(timelineEvents.value, false));
const pastEventGroups = computed(() => processAndGroupEvents(timelineEvents.value, true));
const groupedConferences = computed(() => {
  return [...conferences.value]
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .reduce((acc, conference) => {
        const date = new Date(conference.date);
        const key = `${date.getFullYear()}年 ${date.toLocaleString('zh-CN', { month: 'long' })}`;
        if (!acc[key]) acc[key] = [];
        acc[key].push(conference);
        return acc;
      }, {});
});

</script>

<style scoped>
/* Main Layout */
.main-layout { display: flex; max-width: 1600px; margin: 0 auto; padding: 0 2rem; }

/* Left Panel & Timeline Card */
.left-panel-spacer { flex: 0 0 300px; }
.timeline-card-container {
  position: fixed; top: 88px; width: 300px; height: calc(100vh - 112px); z-index: 10;
  /* --- CHANGE HERE: Removed transform for a pure fade-in --- */
  opacity: 0;
  transition: opacity 0.4s ease-out, filter 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
.timeline-card-container.is-ready {
  opacity: 1;
}
.timeline-card-container.is-blurred { filter: blur(8px); }
.timeline-card {
  width: 100%; height: 100%; background-color: #ffffff; border-radius: 0.75rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;
  display: flex; flex-direction: column;
}

.timeline-header {
  padding: 1.5rem 1.5rem 1rem; flex-shrink: 0; border-bottom: 1px solid #f3f4f6;
}
.timeline-title {
  font-size: 1.25rem; font-weight: 700; color: #1f2937;
}
.timeline-scroll-area {
  flex-grow: 1; overflow-y: auto; padding: 1.5rem 0.5rem 1.5rem 1.5rem;
  scrollbar-width: none; -ms-overflow-style: none;
}
.timeline-scroll-area::-webkit-scrollbar { display: none; }

/* Timeline Design */
.month-group-timeline { margin-bottom: 1.5rem; }
.month-header { font-size: 0.8rem; font-weight: 600; color: #9ca3af; text-transform: uppercase; padding-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; margin-bottom: 0.75rem; }

.past-events-section { margin-top: 2.5rem; }
.past-events-title {
  font-size: 1.25rem; font-weight: 700; color: #1f2937;
  margin-bottom: 1.5rem; padding-left: 0;
}

.timeline-item { display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; transition: all 0.2s ease; }
.timeline-item.has-report { cursor: pointer; }
.timeline-item:not(.has-report) { cursor: default; }
.timeline-item.has-report:not(.is-past):hover { background-color: #f9fafb; }
.timeline-item.is-active { background-color: #eff6ff; }

/* Date Marker */
.date-marker {
  display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0;
  width: 48px; height: 48px; border-radius: 0.5rem; background-color: #f3f4f6; color: #4b5563;
  margin-right: 1rem; transition: all 0.3s ease;
}
.date-marker .day { font-size: 1.25rem; font-weight: 600; line-height: 1.2; }
.date-marker .weekday { font-size: 0.75rem; color: #6b7280; }
.timeline-item.has-report:not(.is-past):hover .date-marker,
.timeline-item.is-active:not(.is-past) .date-marker {
  background-color: #3b82f6; color: white;
}
.timeline-item.has-report:not(.is-past):hover .date-marker .weekday,
.timeline-item.is-active:not(.is-past) .date-marker .weekday {
  color: rgba(255,255,255,0.8);
}

/* Event Details */
.event-details { display: flex; flex-direction: column; align-items: flex-start; min-width: 0; }
.event-title { font-weight: 600; color: #374151; font-size: 0.9rem; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; transition: color 0.3s ease; }
.badges-container { margin-top: 0.25rem; display: flex; gap: 0.5rem; }

/* Badge Styles */
.report-badge { font-size: 0.75rem; font-weight: 500; padding: 2px 8px; border-radius: 999px; line-height: 1.2; }
.report-badge-archived { background-color: #dcfce7; color: #166534; }
.report-badge-upcoming { background-color: #fef3c7; color: #b45309; }
.hover-badge { background-color: #eff6ff; color: #3b82f6; opacity: 0; transition: opacity 0.3s ease; position: absolute; }
.timeline-item.has-report:not(.is-past):hover .hover-badge { opacity: 1; }
.timeline-item.has-report:not(.is-past):hover .report-badge-upcoming { opacity: 0; }

/* Past Event Styling & Enhanced Hover Effect */
.timeline-item.is-past { opacity: 0.6; }
.timeline-item.is-past .date-marker { background-color: #e5e7eb; }
.timeline-item.is-past.has-report:hover {
  opacity: 1; background-color: #eff6ff;
}
.timeline-item.is-past.has-report:hover .date-marker,
.timeline-item.is-past.is-active .date-marker {
  background-color: #6b7280; color: white;
}
.timeline-item.is-past.has-report:hover .date-marker .weekday,
.timeline-item.is-past.is-active .date-marker .weekday {
  color: rgba(255,255,255,0.8);
}
.timeline-item.is-past.has-report:hover .event-title,
.timeline-item.is-past.is-active .event-title {
  color: #1f2937;
}

/* Right Panel */
.right-panel { flex: 1; min-width: 0; padding-left: 2rem; }
.right-panel-content-area {
  padding-top: 3rem;
  padding-bottom: 24px;
}
.container { padding-top: 0 !important; padding-bottom: 0 !important; }
.page-header h1 { letter-spacing: 1px; }
.month-divider { display: flex; align-items: center; margin-bottom: 2.5rem; }
.month-divider::after { content: ''; flex: 1; border-bottom: 1px solid #e5e7eb; margin-left: 1.5em; }
.month-text { font-size: 1.25rem; font-weight: 600; color: #4b5563; padding-right: 1.5rem; }

/* Conference Card Effects */
.conference-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid #e5e7eb;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  cursor: pointer;
}
.conference-card:has(.hover-link:hover) { cursor: default; }

.conference-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07);
}
.conference-card.is-active {
  transform: scale(1.03) translateY(0) !important;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5), 0 12px 24px rgba(0, 0, 0, 0.1);
}
.conference-card img { transition: transform 0.3s ease; }
.conference-card:hover img { transform: scale(1.05); }
.conference-card.is-active img { transform: scale(1.05); }
.card-meta { border-top: 1px solid #f3f4f6; padding-top: 1rem; position: relative; }

.meta-action {
  position: relative;
  height: 16px;
  display: flex;
  align-items: center;
}
.default-text, .hover-link {
  display: flex;
  align-items: center;
  gap: 4px;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.hover-link {
  position: absolute;
  top: 0;
  right: 0;
  opacity: 0;
  transform: translateY(5px);
  color: #6b7280;
  text-decoration: none;
  white-space: nowrap;
}
.link-icon {
  width: 14px;
  height: 14px;
}
.group:has(.hover-link):hover .default-text {
  opacity: 0;
  transform: translateY(-5px);
}
.group:has(.hover-link):hover .hover-link {
  opacity: 1;
  transform: translateY(0);
}
.hover-link:hover {
  transform: translateY(0) scale(1.1);
  color: #1d1d1f;
}

@media (max-width: 1024px) {
  .left-panel-spacer { display: none; }
  .right-panel { padding-left: 0; }
  .right-panel-content-area { padding-bottom: 3rem; }
  .main-layout { padding: 0 1rem; }
}
</style>